<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Couchbase Query Performance Guide & N1QL Glossary</title>
    <meta name="description" content="Minimal, structured guide to debugging Couchbase slow queries with step-by-step workflow, performance strategy (Crawl/Walk/Run), and a concise glossary.">
    <link rel="canonical" href="https://cb.fuj.io/analysis_hub.html">
    <style>
        /* Base look & feel (match index.html) */
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; background: #f5f7fa; color: #333; line-height: 1.6; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        a { color: #007acc; text-decoration: none; }
        a:hover { text-decoration: underline; }

        /* Gradient header (from index.html) */
        header { text-align: center; padding: 12px 20px; background: linear-gradient(135deg, #007acc 0%, #00b4d8 100%); color: white; border-radius: 0 0 12px 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
        header h1 { font-size: 2em; margin: 4px 0 2px; letter-spacing: 0.2px; }
        header p { margin: 0 0 6px; opacity: 0.95; }

        /* Layout */
        .container { display: flex; gap: 20px; padding: 20px; max-width: 1400px; margin: 0 auto; }
        .sidebar { position: fixed; left: 20px; top: 120px; bottom: 20px; width: 260px; background: #fff; padding: 16px; overflow-y: auto; border: 1px solid #eaeef2; border-radius: 10px; box-shadow: 0 4px 14px rgba(0,0,0,0.06); }
        .sidebar h2 { font-size: 16px; color: #2d3748; margin: 0 0 8px; }
        .sidebar ul { list-style: none; margin: 0; padding: 0; }
        .sidebar li { margin: 6px 0; font-size: 14px; }
        .sidebar .sub { margin-left: 14px; font-size: 13px; color: #4a5568; }

        .content { margin-left: 300px; padding: 6px 0 30px; max-width: 920px; }

        /* Cards/sections */
        .card, .guide-step { background: #fff; padding: 20px; border-radius: 10px; border: 1px solid #eaeef2; box-shadow: 0 4px 14px rgba(0,0,0,0.06); margin-bottom: 20px; }
        .section-title { font-size: 1.6em; color: #007acc; margin: 10px 0 12px; position: relative; }
        .section-title::after { content: ""; display: block; width: 56px; height: 3px; background: #00b4d8; border-radius: 2px; margin-top: 8px; }

        h3 { color: #2d3748; margin: 8px 0 6px; }
        code { background: #f8f9fa; padding: 2px 6px; border-radius: 4px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color: #d6336c; }

        /* Informational note */
        .note { background: #f0f8ff; border: 1px solid #e6eef5; color: #1e3a8a; padding: 12px 14px; border-radius: 8px; }

        /* Mini accents similar to index.html */
        .sql-code { background:#f6f8fa; color:#24292e; padding:15px; border-radius:8px; font-family:'Courier New',monospace; font-size:14px; line-height:1.4; margin:15px 0; overflow-x:auto; border-left:4px solid #0366d6; position:relative; padding-right:80px }
        .sql-copy-btn { position:absolute; top:8px; right:8px; background:#007bff; color:#fff; border:none; border-radius:6px; padding:6px 12px; font-size:11px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.12) }
        .sql-copy-btn:hover { background:#0056b3 }

        /* Floating GitHub icon + version badge */
        .floating-github{position:fixed;bottom:10px;right:10px;z-index:999;text-align:center}
        .floating-github img{width:40px;height:40px;filter: drop-shadow(0 2px 6px rgba(0,0,0,0.2))}
        .floating-github .copyright{margin-top:6px;font-size:12px;color:#777}
        .version-info{position:fixed;bottom:10px;left:10px;background:rgba(0,0,0,0.1);color:#333;padding:4px 8px;border-radius:4px;font-size:0.75em;font-family:monospace;z-index:999;opacity:0.7;transition:opacity 0.3s ease}
        .version-info:hover{opacity:1;background:rgba(0,0,0,0.2)}

        /* Accessible focus styles */
        a:focus-visible, button:focus-visible { outline: 3px solid rgba(0,122,204,0.35); outline-offset: 2px; border-radius: 6px; }

        footer { text-align:center; padding: 20px; font-size: 0.9em; color: #666; border-top: 1px solid #eaeef2; margin-top: 30px; }

        /* Sidebar toggle (kept minimal) */
        .sidebar-toggle{cursor:pointer;padding:10px; position:fixed; left: 0; top: 50%; transform: translateY(-50%); z-index:1001}
        .sidebar-toggle .arrow{fill:none;stroke:#2980b9;stroke-width:2; transition: transform 0.3s ease}
        .sidebar-collapsed .sidebar{transform:translateX(-300px)}
        .sidebar-collapsed .content{margin-left:20px}
        .sidebar-collapsed .sidebar-toggle .arrow{transform:rotate(180deg)}

        @media (max-width: 980px) {
          .sidebar { position: static; width: auto; margin: 0 0 10px; top: auto; left: auto; right: auto; bottom: auto; }
          .content { margin-left: 0; padding: 0 20px 30px; }
          .container { flex-direction: column; padding: 12px; }
          .sidebar-toggle { display:none; }
        }
    </style>
</head>
<body>
    <!-- Floating GitHub link -->
    <div class="floating-github">
        <a href="https://github.com/Fujio-Turner/cb_completed_request" target="_blank" rel="noopener noreferrer">
            <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub repository" />
        </a>
        <div class="copyright">© 2025 fuj.io</div>
    </div>

    <header>
        <h1>Couchbase Query Performance Guide</h1>
        <p>Minimal, structured walkthrough: processing data, reading stats, Crawl/Walk/Run strategy, and glossary.</p>
    </header>

    <div id="sidebarToggle" class="sidebar-toggle" aria-label="Toggle topics" title="Toggle topics">
        <svg class="arrow" width="24" height="24" viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg>
    </div>

    <div class="container">
        <nav class="sidebar">
            <h2>Navigation</h2>
            <ul>
                <li><a href="#part1">Part 1 · Process → Charts & Stats</a></li>
                <li class="sub"><a href="#parseJSON">• Parse JSON</a></li>
                <li class="sub"><a href="#tabs">• Analyzer Tabs</a></li>
                <li><a href="#part2">Part 2 · Read the Stats</a></li>
                <li class="sub"><a href="#readStats">• What the tables mean</a></li>
                <li class="sub"><a href="#timingOverview">• Timing relationships</a></li>
                <li class="sub"><a href="#systemMetrics">• System & node impact</a></li>
                <li class="sub"><a href="#queryPhases">• Execution phases</a></li>
                <li><a href="#part3">Part 3 · Crawl → Walk → Run</a></li>
                <li class="sub"><a href="#optimizationLevels">• Level metrics</a></li>
                <li class="sub"><a href="#practicalAnalysis">• Practical tips</a></li>
                <li><a href="#part4">Part 4 · Glossary</a></li>
                <li class="sub"><a href="#scanConsistency">• scanConsistency</a></li>
                <li class="sub"><a href="#serviceTime">• serviceTime</a></li>
                <li class="sub"><a href="#elapsedTime">• elapsedTime</a></li>
                <li class="sub"><a href="#cpuTime">• cpuTime</a></li>
                <li class="sub"><a href="#state">• state</a></li>
                <li class="sub"><a href="#usedMemory">• usedMemory</a></li>
            </ul>
        </nav>

        <main class="content">
            <div class="card note" id="intro-note">
                <strong>Note:</strong> If you want the gradient header added like index.html, I can insert a header section above the sidebar and adjust the sidebar positioning accordingly.
            </div>

            <!-- Part 1 -->
            <section id="part1" class="guide-step">
                <h2 class="section-title">Part 1 · How to process and generate charts and stats</h2>
                <div id="parseJSON">
                    <h3>Parse JSON</h3>
                    <img src="img/parse_json_button.png" alt="Parse JSON button in the analyzer" style="float:left; max-width:40%; width: 260px; height:auto; border:1px solid #ddd; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.08); margin: 0 16px 8px 0;" loading="lazy">
                    <p>The Parse JSON feature allows you to analyze query results and apply advanced filtering directly within the Query Analyzer tool. Multiple filtering options help you focus on specific data subsets for targeted analysis.</p>
                    <div style="clear: both;"></div>
                </div>

                <div id="tabs" style="margin-top:16px">
                    <h3>Analyzer Tool Tabs</h3>
                    <p>The Couchbase Query Analyzer provides multiple tabs with specialized features to help you analyze query performance and troubleshoot issues from different perspectives.</p>
                    <div class="note" id="dashboard">
                        <h4 style="margin-top:0">Dashboard</h4>
                        <p>High-level overview with draggable charts showing query duration distribution, index type usage, scan consistency patterns, result size analysis, and system health metrics.</p>
                    </div>
                    <div class="note" id="insights">
                        <h4 style="margin-top:0">Insights</h4>
                        <p>Automated analysis across index performance, resource utilization, and query patterns with live metrics.</p>
                    </div>
                    <div class="note" id="timeline">
                        <h4 style="margin-top:0">Timeline</h4>
                        <p>Chronological time-series with zoom. Track patterns by seconds to days; dual Y-axes for metrics.</p>
                    </div>
                    <div class="note" id="queryGroup">
                        <h4 style="margin-top:0">Query Groups</h4>
                        <p>Group similar normalized queries; compare aggregate stats and optimize common patterns.</p>
                    </div>
                    <div class="note" id="everyQuery">
                        <h4 style="margin-top:0">Every Query</h4>
                        <p>Tabular details with sorting and search; drill into plans and metrics for debugging.</p>
                    </div>
                    <div class="note" id="indexQueryFlow">
                        <h4 style="margin-top:0">Index/Query Flow</h4>
                        <p>Visual flow connecting indexes to queries; identify coverage and usage gaps.</p>
                    </div>
                    <div class="note" id="indexesTab">
                        <h4 style="margin-top:0">Indexes</h4>
                        <p>Inventory and metrics for indexes by bucket/scope/collection. Includes separate query to fetch definitions:</p>
                        <div class="sql-code">
<pre>SELECT 
    s.name,
    s.id,
    s.metadata,
    s.state,
    s.num_replica,
    s.`using` AS indexType,
    CONCAT("CREATE INDEX ", s.name, " ON ", k, ks, p, w, ";") AS indexString
FROM system:indexes AS s
LET bid = CONCAT("", s.bucket_id, ""),
    sid = CONCAT("", s.scope_id, ""),
    kid = CONCAT("", s.keyspace_id, ""),
    k = NVL2(bid, CONCAT2(".", bid, sid, kid), kid),
    ks = CASE WHEN s.is_primary THEN "" ELSE "(" || CONCAT2(",", s.index_key) || ")" END,
    w = CASE WHEN s.condition IS NOT NULL THEN " WHERE " || REPLACE(s.condition, '"', "'") ELSE "" END,
    p = CASE WHEN s.`partition` IS NOT NULL THEN " PARTITION BY " || s.`partition` ELSE "" END;</pre>
                            <button class="sql-copy-btn">Copy</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Part 2 -->
            <section id="part2" class="guide-step">
                <h2 class="section-title">Part 2 · What the stats and tables mean</h2>
                <div id="readStats">
                    <h3>Reading the Performance Data</h3>
                    <img src="img/stats_to_plan.png" alt="Query statistics table showing performance metrics" style="max-width:100%; border:1px solid #e6eef2; border-radius:8px;">
                    <div class="note">
                        <strong>How to use:</strong> Start with timing metrics; then correlate with phase counts/times and system metrics.
                    </div>
                </div>
                <div id="timingOverview" style="margin-top:12px">
                    <h3>Timing Relationships</h3>
                    <img src="img/query_times.png" alt="Complete timing metrics relationship diagram">
                    <h4>ServiceTime in context</h4>
                    <img src="img/serviceTime.png" alt="ServiceTime breakdown" loading="lazy">
                </div>
                <div id="systemMetrics" style="margin-top:12px">
                    <h3>System & Node Impact</h3>
                    <img src="img/query_node.png" alt="Query node architecture impact">
                </div>
                <div id="queryPhases" style="margin-top:12px">
                    <h3>Execution Phases</h3>
                    <p>Common phases: <code>indexScan</code>, <code>fetch</code>, <code>project</code>, <code>sort</code>, <code>authorize</code>, <code>parse</code>, <code>plan</code>, <code>run</code>, <code>stream</code></p>
                </div>
            </section>

            <!-- Part 3 -->
            <section id="part3" class="guide-step">
                <h2 class="section-title">Part 3 · Crawl → Walk → Run (performance strategy)</h2>
                <div id="optimizationLevels">
                    <h3>Level Metrics</h3>
                    <div class="note">
                        <strong>CRAWL:</strong> High <code>phaseCounts.fetch</code>, large <code>resultSize</code>, higher <code>serviceTime</code>
                    </div>
                    <div class="note">
                        <strong>WALK:</strong> Reduced <code>fetch</code>, targeted <code>indexScan</code>, improved <code>serviceTime</code>
                    </div>
                    <div class="note">
                        <strong>RUN:</strong> <code>fetch = 0</code> (covering index), minimal <code>resultSize</code>, optimal <code>serviceTime</code>
                    </div>
                </div>
                <div id="practicalAnalysis" style="margin-top:12px">
                    <h3>Practical Tips</h3>
                    <ul>
                        <li>High <code>kernTime</code> → CPU contention; check system load and concurrency</li>
                        <li>High <code>phaseCounts.fetch</code> → add covering indexes</li>
                        <li>Large <code>resultSize</code> vs <code>resultCount</code> → optimize projections and indexes</li>
                        <li>Large <code>elapsedTime</code> – <code>serviceTime</code> gap → queuing; scale query nodes</li>
                    </ul>
                </div>
            </section>

            <!-- Part 4 -->
            <section id="part4" class="guide-step">
                <h2 class="section-title">Part 4 · Glossary</h2>
                <div id="scanConsistency" class="card">
                    <h3>scanConsistency</h3>
                    <p>Controls freshness vs performance for index reads. Options: <strong>not_bounded</strong> (fastest), <strong>at_plus</strong>, <strong>request_plus</strong> (freshest).</p>
                </div>
                <div id="serviceTime" class="card">
                    <h3>serviceTime</h3>
                    <p>Calendar time spent actively executing the query across phases (Plan → Index Scan → Fetch → Project → Stream).</p>
                </div>
                <div id="elapsedTime" class="card">
                    <h3>elapsedTime</h3>
                    <p>End-to-end time including queuing and result transmission.</p>
                </div>
                <div id="cpuTime" class="card">
                    <h3>cpuTime</h3>
                    <p>Cumulative CPU consumed across threads; indicates CPU-bound workload when high vs serviceTime.</p>
                </div>
                <div id="state" class="card">
                    <h3>state</h3>
                    <p>Execution status: completed, running, cancelled, timeout, error.</p>
                </div>
                <div id="usedMemory" class="card">
                    <h3>usedMemory</h3>
                    <p>Peak document memory consumption (shown when memory_quota is configured).</p>
                </div>
            </section>

            <footer>
                &copy; 2025 Couchbase Performance Analysis Hub<br>© 2025 fuj.io
            </footer>
        </main>
    </div>

    <div class="version-info">Couchbase Query Performance Guide v3.16.3</div>

    <script>
        // Copy buttons
        document.querySelectorAll('.sql-copy-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const codeContainer = button.closest('.sql-code') || button.parentElement.querySelector('pre');
                let code = '';
                if (codeContainer) {
                    const clone = codeContainer.cloneNode(true);
                    clone.querySelectorAll('button').forEach(b => b.remove());
                    code = clone.textContent.replace(/\s*Copy\s*$/,'').trim();
                }
                navigator.clipboard.writeText(code).then(() => {
                    button.style.background = '#28a745';
                    const prev = button.textContent;
                    button.textContent = 'Copied!';
                    setTimeout(() => { button.textContent = prev; button.style.background = ''; }, 2000);
                }).catch(err => { console.error('Failed to copy: ', err); });
            });
        });
    </script>
    <script>
        // Sidebar toggle
        (function(){
          const toggle = document.getElementById('sidebarToggle');
          if (!toggle) return;
          toggle.addEventListener('click', () => {
            document.body.classList.toggle('sidebar-collapsed');
          });
        })();
    </script>
</body>
</html>
