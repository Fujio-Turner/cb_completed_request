<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Couchbase Slow Query Analysis Tool - Quick Start Guide</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .guide-container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Updated to 2 columns */
            gap: 20px;
            margin-bottom: 20px;
        }
        .guide-step {
            background: white;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .guide-step h3 {
            margin-top: 0;
            font-size: 18px;
            color: #333;
        }
        .guide-step p, .guide-step ul {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }
        .guide-step pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            overflow-x: auto;
        }
        .guide-step a {
            color: #007bff;
            text-decoration: none;
        }
        .guide-step a:hover {
            text-decoration: underline;
        }
        .guide-step img {
            max-width: 100%;
            height: auto;
        }
        .video-placeholder {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            color: #666;
            font-size: 14px;
        }
        .sql-query-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            position: relative;
        }
        .sql-query-box pre {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .sql-copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
        }
        .sql-copy-btn:hover {
            background: #0056b3;
        }
        .version-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.1);
            color: #333;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-family: monospace;
            z-index: 999;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }
        .version-info:hover {
            opacity: 1;
            background: rgba(0,0,0,0.2);
        }
        footer {
            position: fixed;
            bottom: 10px;
            right: 10px;
            z-index: 999;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Couchbase Slow Query Analysis Tool - Quick Start Guide</h1>
    <p>A comprehensive web-based tool for analyzing Couchbase query performance and execution plans. (Capella compatible)</p>

    <div class="guide-container">
        <!-- Step 1 -->
        <div class="guide-step">
            <h3>Step 1: Extract Query Data</h3>
            <p>Run the below query in your Couchbase Query Workbench or <code>cbq</code>.</p> 
            <p>You will want to copy or save the JSON output.</p>
            <div class="sql-query-box">
                <pre>SELECT *, meta().plan FROM system:completed_requests ORDER BY requestId LIMIT 2000;</pre>
                <button class="sql-copy-btn">Copy</button>
            </div>
            <p><strong>Notes:</strong>This query returns a JSON of 9-15MB optimized for browser performance.</p>
            <p><a href="sql_queries.md">Advanced Query Options</a></p>
        </div>
        <div class="guide-step">
            <img src="img/completed_request_json.png" alt="Query output JSON" style="width: 550px;">
        </div>

        <!-- Step 2 -->
        <div class="guide-step">
            <h3>Step 2: Access Hosted Tool</h3>
            <p>Click the link below to go to the web based query analyzer tool. Pick by <strong>Language-Specific:</strong></p>
            <ul>
                <li><span style="font-size: large;"><a href="https://cb.fuj.io/en/" target="_blank" rel="noopener noreferrer">https://cb.fuj.io/en/ (English)</a></span></li>
                <li><span style="font-size: large;"><a href="https://cb.fuj.io/de/" target="_blank" rel="noopener noreferrer">https://cb.fuj.io/de/ (German)</a></span></li>
                <li><span style="font-size: large;"><a href="https://cb.fuj.io/es/" target="_blank" rel="noopener noreferrer">https://cb.fuj.io/es/ (Spanish)</a></span></li>
                <li><span style="font-size: large;"><a href="https://cb.fuj.io/pt/" target="_blank" rel="noopener noreferrer">https://cb.fuj.io/pt/ (Portuguese)</a></span></li>
            </ul>
            <p>  <img src="img/firefox.png" alt="FireFox" style="width: 30px;"> <em>Firefox</em> renders data the fastest.</p>
        </div>
        <div class="guide-step">
       <img src="img/copy_paste_side_by_side.png" alt="Steps from Query to Analyze" style="width: 650px;" >
        </div>

        <!-- Step 3 -->
        <div class="guide-step">
            <h3>Step 3: Paste & Analyze</h3>
            <p>Copy the JSON output from Step 1 and paste it into the <span style="font-size: large; color: black;"><b>Upper Left</b></span> text box, then click the <strong>Parse JSON</strong> button.</p>
            <img src="img/paste_json.png" alt="Paste JSON and click Parse JSON">
        </div>
        <div class="guide-step">
            <img src="img/timeline.png" alt="Timeline Charts">
        </div>

        <!-- Step 4 -->
        <div class="guide-step">
            <h3>Step 4: Filter and Index Analysis (Optional)</h3>
            <p><strong>Filter by:</strong></p>
            <ul>
                <li><strong>Auto-population:</strong> Date fields populate with your data's full time range.</li>
                <li><strong>Custom Date Ranges:</strong> Adjust "From" and "To" dates or filter by specific SQL++ query terms.</li>
                <li><strong>SQL++ Term Search:</strong> Filter by specific SQL++ query terms. EX. <i>`SELECT city , state`</i></li>
                <li><strong>Re-analyze:</strong> Click <strong>Parse JSON</strong> to apply filters.</li>
                <li><strong>Filter status:</strong> View the number of queries matching your criteria.</li>
            </ul>

        </div>
        <div class="guide-step">

            <p><strong>Enhanced Index Analysis:</strong></p>
            <p>To retrieve the current list of indexes in your cluster and connect them to slow queries, run the query below in your workbench (as in Step 1). Paste the JSON output into the <span style="font-size: large; color: black;"><b>Upper Right</b></span> text box.</p>
            <div class="sql-query-box">
                <pre>
SELECT 
    s.name,
    s.id,
    s.metadata,
    s.state,
    s.num_replica,
    CONCAT("CREATE INDEX ", s.name, " ON ", k, ks, p, w, ";") AS indexString
FROM system:indexes AS s
LET bid = CONCAT("", s.bucket_id, ""),
    sid = CONCAT("", s.scope_id, ""),
    kid = CONCAT("", s.keyspace_id, ""),
    k = NVL2(bid, CONCAT2(".", bid, sid, kid), kid),
    ks = CASE WHEN s.is_primary THEN "" ELSE "(" || CONCAT2(",", s.index_key) || ")" END,
    w = CASE WHEN s.condition IS NOT NULL THEN " WHERE " || REPLACE(s.condition, '"', "'") ELSE "" END,
    p = CASE WHEN s.`partition` IS NOT NULL THEN " PARTITION BY " || s.`partition` ELSE "" END;
            </pre>
                <button class="sql-copy-btn">Copy</button>
            </div>
            <p><strong>Example Index Query Output:</strong></p>
            <pre>[{
  "name": "#primary",
  "id": "acd3909da629f840",
  "metadata": {
    "last_scan_time": "2025-02-26T08:39:39.681-08:00",
    "num_replica": 0,
    "stats": {
      "last_known_scan_time": 1740587979681244700
    }
  },
  "state": "online",
  "indexString": "CREATE INDEX #primary ON customer_addresses;"
}]</pre>
        </div>

        <!-- Step 5: Download -->
        <div class="guide-step">
            <h3>Download the Tool (Optional)</h3>
            <p>If you prefer to use the tool locally you can get the raw HTML BELOW , copy/paste HTML and save it as index.html :</p>
            <ul>
                <li><a href="https://raw.githubusercontent.com/Fujio-Turner/cb_completed_request/main/en/index.html">English (index.html)</a></li>
                <li><a href="https://raw.githubusercontent.com/Fujio-Turner/cb_completed_request/main/de/index.html">German (index.html)</a></li>
                <li><a href="https://raw.githubusercontent.com/Fujio-Turner/cb_completed_request/main/es/index.html">Spanish (index.html)</a></li>
                <li><a href="https://raw.githubusercontent.com/Fujio-Turner/cb_completed_request/main/pt/index.html">Portuguese (index.html)</a></li>
            </ul>
        </div>
        <div class="guide-step">
            <p>Tested and Compatible with Couchbase 7.6.6 and Capella</p>
            <p>Feature List & Release Notes</p>
            <a href="https://github.com/Fujio-Turner/cb_completed_request/blob/main/README.md#features" target="_blank" rel="noopener noreferrer">https://github.com/Fujio-Turner/cb_completed_request</a></li>
        </div>
    </div>

    <div class="version-info">Couchbase Slow Query Analysis Tool v3.5.1</div>

    <footer>
        <a href="https://github.com/Fujio-Turner/cb_completed_request" target="_blank" rel="noopener noreferrer">
            <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub Repository for Couchbase Slow Query Analysis Tool" width="40" height="40">
        </a>
    </footer>

    <script>
        document.querySelectorAll('.sql-copy-btn').forEach(button => {
            button.addEventListener('click', () => {
                const code = button.parentElement.querySelector('pre').textContent;
                navigator.clipboard.writeText(code).then(() => {
                    button.textContent = 'Copied!';
                    setTimeout(() => {
                        button.textContent = 'Copy';
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                });
            });
        });
    </script>
</body>
</html>