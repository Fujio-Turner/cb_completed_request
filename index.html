<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Query Analyzer</title>
    <!-- Include jQuery UI CSS -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        #input-section {
            margin-bottom: 20px;
        }
        textarea {
            width: 100%;
            height: 50px;
            margin-bottom: 10px;
        }
        #tabs {
            flex: 1;
            overflow: auto;
        }
        #every-query, #analysis {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        #flow-diagram-section, #charts-placeholder {
            flex: 0 0 250px; /* Fixed height for charts and flow diagram */
            overflow: auto;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #fff;
        }
        #flow-diagram {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .step-bubble {
            border: 1px solid #000;
            border-radius: 10px;
            padding: 10px;
            /*min-width: 110px;*/
            text-align: center;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .step-bubble p {
        margin: 5px 0;
        line-height: 1.0; /* Default is around 1.4–1.6, so this tightens the text */
        }

        .green { background-color: #d4edda; }
        .yellow { background-color: #fff3cd; }
        .orange { background-color: #ffe5d0; }
        .red { background-color: #f8d7da; }
        .connector {
            width: 20px;
            height: 2px;
            background-color: #000;
        }
        #table-section, #analysis-table-section {
            flex: 1;
            overflow-y: auto;
        }
        #table-container, #analysis-table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        tr:hover {
            background-color: #f1f1f1;
            cursor: pointer;
        }
        .primary-scan-yes {
            font-weight: bold;
            color: red;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        #plan-modal-body ul {
            list-style-type: none;
            padding-left: 20px;
        }
        #plan-modal-body li {
            margin-bottom: 5px;
        }
        #operator-modal-body dl {
            margin: 0;
        }
        #operator-modal-body dt {
            font-weight: bold;
        }
        #operator-modal-body dd {
            margin-left: 20px;
        }
    </style>
    <!-- Include Panzoom, jQuery, and jQuery UI -->
    <script src="https://cdn.jsdelivr.net/npm/panzoom@9.4.2/dist/panzoom.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
</head>
<body>
    <!-- Input Section (outside tabs) -->
    <div id="input-section">
        <textarea id="json-input" placeholder="Paste your JSON output from: SELECT * , meta().plan FROM system:completed_requests;"></textarea>
        <button onclick="parseJSON()">Parse JSON</button>
    </div>

    <!-- Tabs Container -->
    <div id="tabs">
        <!-- Tab Headers -->
        <ul>
            <li><a href="#every-query">Every Query</a></li>
            <li><a href="#timeline">Timeline</a></li>
            <li><a href="#analysis">Analysis</a></li>
        </ul>
        <!-- Every Query Tab Content -->
        <div id="every-query">
            <div id="flow-diagram-section">
                <div id="flow-diagram"></div>
            </div>
            <div id="table-section">
                <div id="table-container">
                    <table id="query-table">
                        <thead id="table-header"></thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Timeline Tab Content -->  
         <div id="timeline">
        *Future charts and visualizations will be displayed here.
        </div> 
        
        <!-- Analysis Tab Content -->
        <div id="analysis">
            <div id="charts-placeholder">
                *Future charts and visualizations will be displayed here.
                <canvas id="analysis-chart" width="400" height="200"></canvas>
            </div>
            <div id="analysis-table-section">
                <div id="analysis-table-container">
                    <table id="analysis-table">
                        <thead id="analysis-table-header"></thead>
                        <tbody id="analysis-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (outside tabs) -->
    <div id="plan-modal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <div id="plan-modal-body"></div>
        </div>
    </div>
    <div id="operator-modal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <div id="operator-modal-body"></div>
        </div>
    </div>

    <script>
        // Parse time strings to milliseconds
        function parseTime(timeStr) {
            if (!timeStr) return 0;
            const match = timeStr
                .replace(/(\d+\.?\d*)(\D+)/, '$1 $2')
                .match(/(\d+\.?\d*)\s*(\D+)/);
            if (!match) return 0;
            const value = parseFloat(match[1]);
            const unit = match[2].toLowerCase().trim();
            if (unit === 's') return value * 1000;
            if (unit === 'ms') return value;
            if (unit === 'us' || unit === 'µs') return value / 1000;
            if (unit === 'ns') return value / 1000000;
            return value;
        }

        // Normalize statement by replacing literals and numbers with "?"
        function normalizeStatement(statement) {
            if (!statement) return '';
            let normalized = statement
                .replace(/"(?:[^"\\]|\\.)*"/g, '?')
                .replace(/'(?:[^'\\]|\\.)*'/g, '?')
                .replace(/\b\d+\.?\d*\b/g, '?');
            return normalized;
        }

        // Get color class based on percentage
        function getColorClass(percentage) {
            if (percentage === 'N/A' || isNaN(percentage)) return 'green';
            if (percentage < 25) return 'green';
            if (percentage < 50) return 'yellow';
            if (percentage < 75) return 'orange';
            return 'red';
        }

        // Recursively extract operators from the plan
        function getOperators(operator, operators = []) {
            if (operator) {
                if (operator['#operator']) {
                    operators.push(operator);
                }
                if (operator['~child']) {
                    getOperators(operator['~child'], operators);
                } else if (operator['~children']) {
                    operator['~children'].forEach(child => getOperators(child, operators));
                }
            }
            return operators;
        }


   /*
        // Calculate total kernel time from the plan
        function calculateTotalKernTime(plan) {
            const operators = getOperators(plan);
            let totalKernTime = 0;
            operators.forEach(operator => {
                const stats = operator['#stats'] || {};
                const kernTime = parseTime(stats.kernTime);
                console.log('kernTime:', kernTime);
                if (!isNaN(kernTime)) {
                    totalKernTime += kernTime;
                }
            });
            console.log('totalKernTime:', totalKernTime);
            return totalKernTime;
        }
 */
     
        function calculateTotalKernTime(plan) {
            const operators = getOperators(plan);
            let lastKernTime = 0;
            operators.forEach(operator => {
                const stats = operator['#stats'] || {};
                const kernTime = parseTime(stats.kernTime);
                console.log('kernTime:', kernTime);
                if (!isNaN(kernTime) && kernTime > 0) {
                    lastKernTime = kernTime; // Update to the latest valid kernTime
                }
            });
            console.log('lastKernTime:', lastKernTime);
            return lastKernTime;
        }
       


        // Build operator stats for modal
        function buildOperatorStats(operator) {
            let html = `<h3>Operator: ${operator['#operator'] || 'Unknown'}</h3>`;
            if (operator['#stats']) {
                html += '<dl>';
                for (const [key, value] of Object.entries(operator['#stats'])) {
                    html += `<dt>${key}</dt><dd>${value}</dd>`;
                }
                html += '</dl>';
            } else {
                html += '<p>No stats available.</p>';
            }
            return html;
        }

        // Generate flow diagram
        function generateFlowDiagram(request) {
            const flowDiagram = document.getElementById('flow-diagram');
            flowDiagram.innerHTML = '';
            if (!request || !request.plan) {
                flowDiagram.textContent = 'No execution plan available.';
                return;
            }

            const elapsedTimeMs = parseTime(request.elapsedTime);
            const operators = getOperators(request.plan);

            if (operators.length === 0) {
                flowDiagram.textContent = 'No operators found in the execution plan.';
                return;
            }

            operators.forEach((operator, index) => {
                const operatorName = operator['#operator'] || 'Unknown Operator';
                const stats = operator['#stats'] || {};
                const execTime = stats.execTime || 'N/A';
                const itemsIn = stats['#itemsIn'] !== undefined ? stats['#itemsIn'] : '-';
                const itemsOut = stats['#itemsOut'] !== undefined ? stats['#itemsOut'] : '-';
                const execTimeMs = parseTime(execTime);
                const percentage = elapsedTimeMs > 0 && !isNaN(execTimeMs) 
                    ? (execTimeMs / elapsedTimeMs * 100).toFixed(2) 
                    : 'N/A';

                const bubble = document.createElement('div');
                bubble.className = 'step-bubble';
                const colorClass = getColorClass(parseFloat(percentage));
                bubble.classList.add(colorClass);
                bubble.innerHTML = `
                    <h4>${operatorName}</h4>
                    <p>${execTime} (${percentage}%)</p>
                    <p>${itemsIn} in / ${itemsOut} out</p>
                `;
                bubble.addEventListener('click', () => {
                    const statsHtml = buildOperatorStats(operator);
                    document.getElementById('operator-modal-body').innerHTML = statsHtml;
                    document.getElementById('operator-modal').style.display = 'block';
                });
                flowDiagram.appendChild(bubble);

                if (index < operators.length - 1) {
                    const connector = document.createElement('div');
                    connector.className = 'connector';
                    flowDiagram.appendChild(connector);
                }
            });

            if (request.plan) {
                const viewPlanButton = document.createElement('button');
                viewPlanButton.textContent = 'View Detailed Execution Plan';
                viewPlanButton.style.marginTop = '10px';
                viewPlanButton.addEventListener('click', () => {
                    const planTreeHtml = '<ul>' + buildPlanTree(request.plan) + '</ul>';
                    document.getElementById('plan-modal-body').innerHTML = planTreeHtml;
                    document.getElementById('plan-modal').style.display = 'block';
                });
                flowDiagram.appendChild(viewPlanButton);
            }

            panzoom(flowDiagram, { smoothScroll: false });
        }

        // Build plan tree for modal
        function buildPlanTree(operator) {
            if (!operator) return '';
            let html = `<li>${operator['#operator'] || 'Unknown Operator'}`;
            if (operator['#stats']) {
                const stats = operator['#stats'];
                html += ` - itemsIn: ${stats['#itemsIn'] !== undefined ? stats['#itemsIn'] : 'N/A'}, itemsOut: ${stats['#itemsOut'] !== undefined ? stats['#itemsOut'] : 'N/A'}, execTime: ${stats.execTime || 'N/A'}, kernTime: ${stats.kernTime || 'N/A'}`;
            }
            if (operator['~child']) {
                html += '<ul>' + buildPlanTree(operator['~child']) + '</ul>';
            } else if (operator['~children']) {
                html += '<ul>';
                operator['~children'].forEach(child => {
                    html += buildPlanTree(child);
                });
                html += '</ul>';
            }
            html += '</li>';
            return html;
        }

        // Generate main table
        function generateTable(requests) {
            const tableHeader = document.getElementById('table-header');
            const tableBody = document.getElementById('table-body');
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';

            const columns = [
                '#',
                'requestTime',
                'statementType',
                'elapsedTime',
                'kernTime',
                'KernTime %',
                'cpuTime',
                'serviceTime',
                'resultCount',
                'resultSize',
                'Index(es) Used',
                'Items from Index Scan',
                'Doc Fetch Count',
                'Primary Scan Used',
                'state',
                'statement',
                'users'
            ];

            const headerRow = document.createElement('tr');
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
            });
            tableHeader.appendChild(headerRow);

            requests.sort((a, b) => parseTime(b.elapsedTime) - parseTime(a.elapsedTime));

            requests.forEach((request, index) => {
                const row = document.createElement('tr');
                const totalKernTimeMs = request.plan ? calculateTotalKernTime(request.plan) : 0;
                const elapsedTimeMs = parseTime(request.elapsedTime);

                columns.forEach(col => {
                    const td = document.createElement('td');
                    let value;
                    if (col === '#') {
                        value = index + 1;
                    } else if (col === 'Primary Scan Used') {
                        value = (request.phaseOperators && request.phaseOperators.primaryScan > 0) ? 'Yes' : 'No';
                    } else if (col === 'Index(es) Used') {
                        const indexes = [];
                        if (request.phaseOperators && request.phaseOperators.primaryScan > 0) indexes.push('Primary');
                        if (request.phaseOperators && request.phaseOperators.indexScan > 0) indexes.push('Secondary');
                        value = indexes.length > 0 ? indexes.join(', ') : 'None';
                    } else if (col === 'Items from Index Scan') {
                        if (request.phaseOperators && request.phaseOperators.primaryScan > 0) {
                            value = request.phaseCounts && request.phaseCounts.primaryScan ? request.phaseCounts.primaryScan : 'N/A';
                        } else if (request.phaseOperators && request.phaseOperators.indexScan > 0) {
                            value = request.phaseCounts && request.phaseCounts.indexScan ? request.phaseCounts.indexScan : 'N/A';
                        } else {
                            value = 'N/A';
                        }
                    } else if (col === 'Doc Fetch Count') {
                        value = request.phaseCounts && request.phaseCounts.fetch ? request.phaseCounts.fetch : 'N/A';
                    } else if (col === 'kernTime') {
                        value = totalKernTimeMs > 0 ? `${totalKernTimeMs.toFixed(2)}ms` : 'N/A';
                    } else if (col === 'KernTime %') {
                        value = elapsedTimeMs > 0 && totalKernTimeMs > 0 
                            ? ((totalKernTimeMs / elapsedTimeMs) * 100).toFixed(2) + '%' 
                            : 'N/A';
                    } else {
                        value = request[col] || 'N/A';
                    }
                    td.textContent = value;
                    if (col === 'Primary Scan Used' && value === 'Yes') {
                        td.classList.add('primary-scan-yes');
                    }
                    row.appendChild(td);
                });

                row.addEventListener('click', () => {
                    document.querySelectorAll('tr').forEach(r => r.style.backgroundColor = '');
                    row.style.backgroundColor = '#e0e0e0';
                    generateFlowDiagram(request);
                });
                tableBody.appendChild(row);
            });
        }

        // Calculate statistics for a group of requests based on SQL++ query logic
        function calculateGroupStats(normalized_statement, groupedRequests) {
            const users_agg = groupedRequests.map(r => r.users).filter(u => u);
            const durations = groupedRequests.map(r => {
                const ms = parseTime(r.serviceTime);
                return isNaN(ms) ? NaN : ms / 1000; // Convert ms to seconds
            }).filter(d => !isNaN(d));
            const total_count = durations.length;
            if (total_count === 0) return null;

            const min_duration = Math.min(...durations);
            const max_duration = Math.max(...durations);
            const avg_duration = durations.reduce((sum, d) => sum + d, 0) / total_count;
            const sorted_durations = [...durations].sort((a, b) => a - b);
            const midFloor = Math.floor(total_count / 2);
            const midCeil = Math.ceil(total_count / 2) - 1;
            const median_duration = (sorted_durations[midFloor] + sorted_durations[midCeil]) / 2;

            const fetchValues = groupedRequests.map(r => r.phaseCounts?.fetch || 0);
            const primaryScanValues = groupedRequests.map(r => r.phaseCounts?.primaryScan || 0);
            const indexScanValues = groupedRequests.map(r => r.phaseCounts?.indexScan || 0);
            const avg_fetch = fetchValues.reduce((sum, v) => sum + v, 0) / total_count;
            const avg_primaryScan = primaryScanValues.reduce((sum, v) => sum + v, 0) / total_count;
            const avg_indexScan = indexScanValues.reduce((sum, v) => sum + v, 0) / total_count;

            // Compute user_query_counts as an object: { user: count }
            const uniqueUsers = [...new Set(users_agg)];
            const user_query_counts = {};
            uniqueUsers.forEach(user => {
                user_query_counts[user] = users_agg.filter(v => v === user).length;
            });

            return {
                normalized_statement,
                user_query_counts,
                total_count,
                min_duration_in_seconds: min_duration,
                max_duration_in_seconds: max_duration,
                avg_duration_in_seconds: avg_duration,
                median_duration_in_seconds: median_duration,
                avg_fetch,
                avg_primaryScan,
                avg_indexScan
            };
        }

        // Generate analysis table based on SQL++ query logic
        function generateAnalysisTable(requests) {
            const analysisTableHeader = document.getElementById('analysis-table-header');
            const analysisTableBody = document.getElementById('analysis-table-body');
            analysisTableHeader.innerHTML = '';
            analysisTableBody.innerHTML = '';

            // Group requests by normalized_statement
            const groups = {};
            requests.forEach(request => {
                const stmt = request.preparedText || request.statement;
                if (!stmt) return;
                const upperStmt = stmt.toUpperCase();
                // Apply SQL++ WHERE clause filters
                if (
                    upperStmt.startsWith('INFER ') ||
                    upperStmt.startsWith('ADVISE ') ||
                    upperStmt.startsWith('CREATE ') ||
                    upperStmt.startsWith('CREATE INDEX') ||
                    upperStmt.startsWith('ALTER INDEX') ||
                    upperStmt.includes(' SYSTEM:')
                ) {
                    return;
                }
                const normalized = normalizeStatement(stmt);
                if (!groups[normalized]) {
                    groups[normalized] = [];
                }
                groups[normalized].push(request);
            });

            // Calculate stats for each group
            const groupData = Object.keys(groups)
                .map(key => calculateGroupStats(key, groups[key]))
                .filter(data => data !== null);
            groupData.sort((a, b) => b.total_count - a.total_count);

            // Define table columns
            const analysisColumns = [
                'total_count',
                'min_duration_in_seconds',
                'max_duration_in_seconds',
                'avg_duration_in_seconds',
                'median_duration_in_seconds',
                'avg_fetch',
                'avg_primaryScan',
                'avg_indexScan',
                'normalized_statement',
                'user_query_counts'
            ];

            // Create header row
            const headerRow = document.createElement('tr');
            analysisColumns.forEach(col => {
                const th = document.createElement('th');

                th.textContent = col.replace(/_/g, ' ').replace("in seconds", " (sec)");
                headerRow.appendChild(th);
            });
            analysisTableHeader.appendChild(headerRow);

            // Create data rows
            groupData.forEach(group => {
                const row = document.createElement('tr');
                analysisColumns.forEach(col => {
                    const td = document.createElement('td');
                    let value;
                    if (col === 'user_query_counts') {
                        value = Object.entries(group.user_query_counts)
                            .map(([user, count]) => `${user}: ${count}`)
                            .join(', ');
                    } else if (col === 'total_count') {
                        value = group.total_count;
                    } else if (['min_duration_in_seconds', 'max_duration_in_seconds', 'avg_duration_in_seconds', 'median_duration_in_seconds', 'avg_fetch', 'avg_primaryScan', 'avg_indexScan'].includes(col)) {
                        value = isNaN(group[col]) ? 'N/A' : Number(group[col]).toFixed(3);
                    } else {
                        value = group[col] || 'N/A';
                    }
                    td.textContent = value;
                    row.appendChild(td);
                });
                analysisTableBody.appendChild(row);
            });
        }

        // Parse JSON input
        function parseJSON() {
            const jsonInput = document.getElementById('json-input').value;
            try {
                const data = JSON.parse(jsonInput);
                if (Array.isArray(data)) {
                    const requests = data.map(item => ({
                        ...item.completed_requests,
                        plan: item.plan ? (typeof item.plan === 'string' ? JSON.parse(item.plan) : item.plan) : null
                    }));
                    generateTable(requests);
                    generateAnalysisTable(requests);
                    document.getElementById('flow-diagram').innerHTML = 'Select a query from the table to view the flow diagram.';
                } else {
                    alert('Please provide a valid JSON array.');
                }
            } catch (e) {
                alert('Invalid JSON: ' + e.message);
            }
        }

        // Modal event listeners
        const planModal = document.getElementById('plan-modal');
        const planCloseBtn = planModal.querySelector('.close');
        planCloseBtn.addEventListener('click', () => {
            planModal.style.display = 'none';
        });
        planModal.addEventListener('click', (event) => {
            if (event.target === planModal) {
                planModal.style.display = 'none';
            }
        });

        const operatorModal = document.getElementById('operator-modal');
        const operatorCloseBtn = operatorModal.querySelector('.close');
        operatorCloseBtn.addEventListener('click', () => {
            operatorModal.style.display = 'none';
        });
        operatorModal.addEventListener('click', (event) => {
            if (event.target === operatorModal) {
                operatorModal.style.display = 'none';
            }
        });

        // Initialize jQuery UI Tabs
        $(function() {
            $("#tabs").tabs();
        });
    </script>
</body>
</html>
